<div class="container">
  <button 
    class="theme-toggle" 
    (click)="toggleTheme()"
    [attr.aria-label]="isDarkMode ? 'Switch to light mode' : 'Switch to dark mode'"
    title="Toggle theme"
    type="button">
    <svg 
      *ngIf="!isDarkMode" 
      class="icon moon-icon" 
      xmlns="http://www.w3.org/2000/svg" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      stroke-width="2" 
      stroke-linecap="round" 
      stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
    <svg 
      *ngIf="isDarkMode" 
      class="icon sun-icon" 
      xmlns="http://www.w3.org/2000/svg" 
      viewBox="0 0 24 24" 
      fill="none" 
      stroke="currentColor" 
      stroke-width="2" 
      stroke-linecap="round" 
      stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </button>

  <header>
    <h1>Multi-Stopwatch Timer</h1>
    <div class="display-toggle">
      <button class="btn btn-sm btn-outline" (click)="toggleDisplayFormat()">
        {{ displayInSeconds ? 'Show HH:MM:SS' : 'Show Seconds' }}
      </button>
      <button class="btn btn-sm btn-outline" (click)="toggleHideButtons()">
        {{ hideButtons ? 'Show Buttons' : 'Hide Buttons' }}
      </button>
    </div>
  </header>

  <div class="controls">
    <button class="btn btn-primary" (click)="addStopwatch()">
      Add Stopwatch ({{ stopwatches.length }})
    </button>
    <button class="btn btn-success" (click)="startAll()" [disabled]="stopwatches.length === 0">
      Start All <span class="kbd">Space</span>
    </button>
    <button class="btn btn-warning" (click)="stopAll()" [disabled]="stopwatches.length === 0">
      Stop All <span class="kbd">Space</span>
    </button>
    <button class="btn btn-secondary" (click)="relaunchAll()" [disabled]="stopwatches.length === 0">
      Relaunch All <span class="kbd">R</span>
    </button>
    <button *ngIf="allStopped" class="btn btn-danger" (click)="resetAll()" [disabled]="stopwatches.length === 0">
      Reset All
    </button>
  </div>

  <div class="stopwatches-grid">
    <div 
      *ngFor="let stopwatch of stopwatches; let i = index" 
      class="stopwatch-card" 
      [class.running]="stopwatch.isRunning"
      [class.dragging]="draggedIndex === i"
      draggable="true"
      (dragstart)="onDragStart(i, $event)"
      (dragover)="onDragOver($event)"
      (drop)="onDrop(i, $event)"
      (dragend)="onDragEnd()"
    >
      <div class="card-actions">
        <div class="drag-handle drag-handle-left"></div>
        <div class="card-actions-right">
          <button 
            class="btn-edit-time" 
            (click)="startEditingTime(stopwatch.id)"
            title="Edit time manually"
          >
            ‚úé
          </button>
          <button class="btn-close" (click)="removeStopwatch(stopwatch.id)" title="Remove">√ó</button>
        </div>
      </div>
      <div class="stopwatch-header">
        <input 
          type="text" 
          class="stopwatch-name"
          [value]="stopwatch.name"
          (input)="updateName(stopwatch.id, $any($event.target).value)"
          placeholder="Stopwatch name"
        />
      </div>
      
      <div class="stopwatch-time-wrapper">
        <div 
          *ngIf="editingTime !== stopwatch.id" 
          class="stopwatch-time" 
          (click)="toggleStopwatch(stopwatch.id)"
          title="Click to start/stop"
        >
          {{ formatTime(stopwatch.time) }}
        </div>
        <div *ngIf="editingTime === stopwatch.id" class="time-edit-container">
          <!-- Seconds mode: single input -->
          <input 
            *ngIf="displayInSeconds"
            type="number" 
            class="stopwatch-time-input"
            [value]="getEditTimeValue(stopwatch.id)"
            (keydown.enter)="onEnterEditTime($any($event), stopwatch.id)"
            (keydown.escape)="cancelEditingTime(stopwatch.id)"
            (input)="updateTimeInput(stopwatch.id, $any($event.target).value)"
            placeholder="123.45"
            step="0.01"
            #timeInput
          />
          
          <!-- HH:MM:SS mode: separate inputs -->
          <div *ngIf="!displayInSeconds" class="time-inputs-group">
            <input 
              type="number" 
              class="time-component-input"
              [(ngModel)]="editHours"
              (ngModelChange)="updateTimeComponents(stopwatch.id)"
              (keydown.enter)="onEnterEditTime($any($event), stopwatch.id)"
              (keydown.escape)="cancelEditingTime(stopwatch.id)"
              placeholder="00"
              min="0"
              max="99"
              #hoursInput
            />
            <span class="time-separator">:</span>
            <input 
              type="number" 
              class="time-component-input"
              [(ngModel)]="editMinutes"
              (ngModelChange)="updateTimeComponents(stopwatch.id)"
              (keydown.enter)="onEnterEditTime($any($event), stopwatch.id)"
              (keydown.escape)="cancelEditingTime(stopwatch.id)"
              placeholder="00"
              min="0"
              max="59"
            />
            <span class="time-separator">:</span>
            <input 
              type="number" 
              class="time-component-input"
              [(ngModel)]="editSeconds"
              (ngModelChange)="updateTimeComponents(stopwatch.id)"
              (keydown.enter)="onEnterEditTime($any($event), stopwatch.id)"
              (keydown.escape)="cancelEditingTime(stopwatch.id)"
              placeholder="00"
              min="0"
              max="59"
            />
            <span class="time-separator">.</span>
            <input 
              type="number" 
              class="time-component-input time-component-small"
              [(ngModel)]="editCentiseconds"
              (ngModelChange)="updateTimeComponents(stopwatch.id)"
              (keydown.enter)="onEnterEditTime($any($event), stopwatch.id)"
              (keydown.escape)="cancelEditingTime(stopwatch.id)"
              placeholder="00"
              min="0"
              max="99"
            />
          </div>

          <div class="time-edit-buttons">
            <button class="btn btn-sm btn-success" (click)="finishEditingTime(stopwatch.id)">‚úì</button>
            <button class="btn btn-sm btn-secondary" (click)="cancelEditingTime(stopwatch.id)">‚úï</button>
          </div>
        </div>
      </div>

      <div *ngIf="!hideButtons" class="stopwatch-controls">
        <button 
          class="btn btn-sm"
          [class.btn-success]="!stopwatch.isRunning"
          [class.btn-warning]="stopwatch.isRunning"
          (click)="toggleStopwatch(stopwatch.id)"
        >
          {{ stopwatch.isRunning ? 'Stop' : 'Start' }}
        </button>
        <button class="btn btn-sm btn-secondary" (click)="resetStopwatch(stopwatch.id)">
          Reset
        </button>
      </div>

      <div class="shortcut-section">
        <div *ngIf="editingShortcut === stopwatch.id" class="shortcut-editing">
          Press any key...
        </div>
        <div *ngIf="editingShortcut !== stopwatch.id" class="shortcut-display">
          <span class="shortcut-label">Shortcut:</span>
          <span *ngIf="stopwatch.shortcutKey" class="shortcut-key">{{ stopwatch.shortcutKey }}</span>
          <button *ngIf="!hideButtons && stopwatch.shortcutKey" class="btn-clear-shortcut" (click)="clearShortcut(stopwatch.id)" title="Clear shortcut">√ó</button>
          <button *ngIf="!hideButtons && !stopwatch.shortcutKey" class="btn btn-sm btn-outline" (click)="startEditingShortcut(stopwatch.id)">
            Set Key
          </button>
          <span *ngIf="hideButtons && !stopwatch.shortcutKey" class="shortcut-none">None</span>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="stopwatches.length === 0" class="empty-state">
    <p>No stopwatches yet. Click "Add Stopwatch" to get started!</p>
  </div>

  <footer class="info">
    <p>‚å®Ô∏è Keyboard Shortcuts: <span class="kbd">Space</span> to Start/Stop All, <span class="kbd">R</span> to Relaunch All</p>
    <p>üí° Tip: Click "Set Key" to assign custom shortcuts to individual stopwatches</p>
    <p>üéØ Tip: Drag and drop stopwatches to reorder them</p>
    <p>Data is automatically saved to your browser's local storage</p>
  </footer>

  <div *ngIf="allStopped && stopwatches.length > 0" class="export-section">
    <button class="btn btn-info btn-export" (click)="exportToCSV()">
      Export to CSV
    </button>
  </div>
</div>
